package com.yd.dby.app.config.filter;

import java.io.IOException;

import javax.servlet.FilterChain;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.web.filter.OncePerRequestFilter;

public class FilterConfig extends OncePerRequestFilter {

	@Autowired
	protected StringRedisTemplate redisTemplate;

	@Override
	protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain) throws ServletException, IOException {

		// 请求地址
		String reqUrl = request.getRequestURI();

		// 异常的请求地址
		String errorUrl = "/main/tokenError";

		// 用户token(放在Header里)
		String token = StringUtils.isEmpty(request.getHeader("token")) ? "" : request.getHeader("token");

		// 针对不同的请求做处理
		if (reqUrl.endsWith("/main/userLogin") || reqUrl.contains("/userRegister") || reqUrl.contains("/getRegCode") || reqUrl.contains("/forgetPwd") || reqUrl.contains("/getPwdCode")) {

			// 过滤登录、注册、获取注册验证码、忘记密码、获取忘记密码验证码 接口
			chain.doFilter(request, response);
		} else if (reqUrl.contains("swagger") || reqUrl.contains("/configuration") || reqUrl.contains("/api-docs") || reqUrl.contains("/favicon")) {

			// System.out.println("swagger.." + reqUrl);
			// swagger-ui测试
			chain.doFilter(request, response);
		} else {

			// redis token
			String redisToken = redisTemplate.opsForValue().get(token);
			if (StringUtils.isEmpty(redisToken)) {

				// System.out.println("error.." + reqUrl);
				// token身份异常
				request.getRequestDispatcher(errorUrl).forward(request, response);
				// chain.doFilter(request, response);
			} else {

				// 正常请求
				chain.doFilter(request, response);
			}
		}
	}
}
